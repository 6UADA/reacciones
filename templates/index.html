<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Reaction Manager</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        surface: {
                            DEFAULT: 'rgb(15, 23, 42)',
                            card: 'rgb(20, 30, 52)',
                            hover: 'rgb(26, 38, 64)',
                            input: 'rgb(12, 18, 36)',
                        },
                        brand: {
                            DEFAULT: 'rgb(59, 130, 246)',
                            light: 'rgb(96, 165, 250)',
                            dark: 'rgb(37, 99, 235)',
                            glow: 'rgba(59, 130, 246, 0.15)',
                        },
                        txt: {
                            primary: 'rgb(226, 232, 240)',
                            secondary: 'rgb(148, 163, 184)',
                            muted: 'rgb(100, 116, 139)',
                        },
                        edge: {
                            DEFAULT: 'rgb(30, 41, 59)',
                            light: 'rgb(51, 65, 85)',
                        }
                    },
                    fontFamily: {
                        sans: ['Inter', 'system-ui', '-apple-system', 'sans-serif'],
                    },
                    boxShadow: {
                        'card': '0 4px 24px rgba(0, 0, 0, 0.25)',
                        'card-hover': '0 8px 32px rgba(0, 0, 0, 0.35)',
                        'glow': '0 0 20px rgba(59, 130, 246, 0.2)',
                        'input': '0 2px 8px rgba(0, 0, 0, 0.15)',
                    },
                }
            }
        }
    </script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', system-ui, -apple-system, sans-serif;
            background: rgb(8, 12, 24);
            color: rgb(226, 232, 240);
            min-height: 100vh;
        }

        input[type="number"]::-webkit-inner-spin-button,
        input[type="number"]::-webkit-outer-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }

        input[type="number"] {
            -moz-appearance: textfield;
            appearance: textfield;
        }

        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes pulse-glow {

            0%,
            100% {
                box-shadow: 0 0 20px rgba(59, 130, 246, 0.2);
            }

            50% {
                box-shadow: 0 0 30px rgba(59, 130, 246, 0.4);
            }
        }

        @keyframes shimmer {
            0% {
                background-position: -200% 0;
            }

            100% {
                background-position: 200% 0;
            }
        }

        .animate-fade-in {
            animation: fadeInUp 0.5s ease-out forwards;
        }

        .animate-fade-in-delay-1 {
            animation: fadeInUp 0.5s ease-out 0.1s forwards;
            opacity: 0;
        }

        .animate-fade-in-delay-2 {
            animation: fadeInUp 0.5s ease-out 0.2s forwards;
            opacity: 0;
        }

        .animate-fade-in-delay-3 {
            animation: fadeInUp 0.5s ease-out 0.3s forwards;
            opacity: 0;
        }

        .reaction-card {
            transition: all 0.25s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .reaction-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.35);
        }

        .reaction-card:focus-within {
            border-color: rgb(59, 130, 246);
            box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.25);
        }

        .btn-primary {
            background: linear-gradient(135deg, rgb(59, 130, 246), rgb(37, 99, 235));
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .btn-primary:hover {
            background: linear-gradient(135deg, rgb(96, 165, 250), rgb(59, 130, 246));
            transform: translateY(-1px);
            box-shadow: 0 8px 24px rgba(59, 130, 246, 0.35);
        }

        .btn-primary:active {
            transform: translateY(0);
        }

        .bg-grid {
            background-image:
                radial-gradient(circle at 1px 1px, rgba(59, 130, 246, 0.03) 1px, transparent 0);
            background-size: 40px 40px;
        }

        select {
            background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%2394a3b8' strokeLinecap='round' strokeLinejoin='round' strokeWidth='1.5' d='M6 8l4 4 4-4'/%3e%3c/svg%3e");
            background-position: right 0.75rem center;
            background-repeat: no-repeat;
            background-size: 1.25em 1.25em;
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
        }

        .total-badge {
            background: linear-gradient(135deg, rgba(59, 130, 246, 0.15), rgba(59, 130, 246, 0.05));
            border: 1px solid rgba(59, 130, 246, 0.3);
        }

        .loading-spinner {
            border: 3px solid rgba(255, 255, 255, 0.1);
            border-top: 3px solid white;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            animation: spin 0.8s linear infinite;
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }
    </style>
</head>

<body class="bg-grid">
    <div class="min-h-screen flex flex-col">
        <!-- Header -->
        <header class="border-b border-edge px-6 py-4 backdrop-blur-sm bg-surface/80 sticky top-0 z-50 animate-fade-in">
            <div class="max-w-5xl mx-auto flex items-center justify-between">
                <div class="flex items-center gap-3">
                    <div class="w-10 h-10 rounded-xl bg-brand flex items-center justify-center shadow-glow">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="white" strokeWidth="2.5"
                            strokeLinecap="round" strokeLinejoin="round">
                            <path d="M12 2L2 7l10 5 10-5-10-5z" />
                            <path d="M2 17l10 5 10-5" />
                            <path d="M2 12l10 5 10-5" />
                        </svg>
                    </div>
                    <div>
                        <h1 class="text-xl font-bold text-txt-primary tracking-tight">Reaction Manager</h1>
                        <p class="text-xs text-txt-muted">Panel de control de reacciones</p>
                    </div>
                </div>
                <div class="flex items-center gap-2">
                    <span
                        class="inline-flex items-center gap-1.5 px-3 py-1.5 rounded-full text-xs font-medium bg-emerald-500/10 text-emerald-400 border border-emerald-500/20">
                        <span class="w-1.5 h-1.5 rounded-full bg-emerald-400 animate-pulse"></span>
                        Conectado
                    </span>
                </div>
            </div>
        </header>

        <!-- Main Content -->
        <main class="flex-1 px-4 py-8 md:px-6">
            <div class="max-w-5xl mx-auto flex flex-col gap-6">

                <!-- URL Section -->
                <section class="bg-surface-card rounded-2xl border border-edge p-6 shadow-card animate-fade-in-delay-1">
                    <div class="flex items-center gap-2 mb-4">
                        <div class="w-8 h-8 rounded-lg bg-brand/10 flex items-center justify-center">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="rgb(96, 165, 250)"
                                strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                                <path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71" />
                                <path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71" />
                            </svg>
                        </div>
                        <div>
                            <h2 class="text-base font-semibold text-txt-primary">URL del Post de Facebook</h2>
                            <p class="text-xs text-txt-muted">Ingresa el enlace de la publicacion</p>
                        </div>
                    </div>
                    <input type="url" id="postUrl" placeholder="https://www.facebook.com/..."
                        class="w-full px-4 py-3 rounded-xl bg-surface-input border border-edge text-txt-primary placeholder-txt-muted text-sm focus:outline-none focus:ring-2 focus:ring-brand/50 focus:border-brand transition-all shadow-input" />
                </section>

                <section class="bg-surface-card rounded-2xl border border-edge p-6 shadow-card animate-fade-in-delay-2">
                    <div class="flex items-center justify-between mb-4">
                        <div class="flex items-center gap-2">
                            <div class="w-8 h-8 rounded-lg bg-brand/10 flex items-center justify-center">
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="rgb(96, 165, 250)"
                                    strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                                    <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2" />
                                    <circle cx="9" cy="7" r="4" />
                                    <path d="M23 21v-2a4 4 0 0 0-3-3.87" />
                                    <path d="M16 3.13a4 4 0 0 1 0 7.75" />
                                </svg>
                            </div>
                            <div>
                                <h2 class="text-base font-semibold text-txt-primary">Rango de Grupos</h2> 
                                <p class="text-xs text-txt-muted">Selecciona el rango de grupos para la campaña</p>
                            </div>
                        </div>
                        <div class="relative w-48">
                            <input type="text" id="groupFilter" placeholder="Buscar grupo..."
                                class="w-full px-3 py-1.5 rounded-lg bg-surface-input border border-edge text-txt-primary placeholder-txt-muted text-xs focus:outline-none focus:ring-1 focus:ring-brand" />
                        </div>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label class="block text-xs font-medium text-txt-secondary mb-2">Desde Grupo</label>
                            <select id="fromGroup"
                                class="group-select w-full px-4 py-3 rounded-xl bg-surface-input border border-edge text-txt-primary text-sm focus:outline-none focus:ring-2 focus:ring-brand/50 focus:border-brand transition-all shadow-input cursor-pointer pr-10">
                                <option value="">Cargando grupos...</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-xs font-medium text-txt-secondary mb-2">Hasta Grupo (Rango)</label>
                            <select id="toGroup"
                                class="group-select w-full px-4 py-3 rounded-xl bg-surface-input border border-edge text-txt-primary text-sm focus:outline-none focus:ring-2 focus:ring-brand/50 focus:border-brand transition-all shadow-input cursor-pointer pr-10">
                                <option value="">-- Solo primer grupo --</option>
                            </select>
                        </div>
                    </div>
                </section>

                <!-- Reactions Config -->
                <section class="bg-surface-card rounded-2xl border border-edge p-6 shadow-card animate-fade-in-delay-3">
                    <div class="flex items-center justify-between mb-6">
                        <div class="flex items-center gap-2">
                            <div class="w-8 h-8 rounded-lg bg-brand/10 flex items-center justify-center">
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="rgb(96, 165, 250)"
                                    strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                                    <circle cx="12" cy="12" r="10" />
                                    <path d="M8 14s1.5 2 4 2 4-2 4-2" />
                                    <line x1="9" y1="9" x2="9.01" y2="9" />
                                    <line x1="15" y1="9" x2="15.01" y2="9" />
                                </svg>
                            </div>
                            <div>
                                <h2 class="text-base font-semibold text-txt-primary">Configuracion de Campaña</h2>
                                <p class="text-xs text-txt-muted" id="configDesc">Define los parametros de tu
                                    interaccion</p>
                            </div>
                        </div>
                        <div class="flex flex-col items-end gap-1">
                            <div id="totalBadge"
                                class="total-badge px-4 py-2 rounded-xl text-sm font-semibold text-brand-light">
                                Total: <span id="totalCount">0</span>
                            </div>
                            <div id="capacityAlert" class="text-[10px] font-medium text-amber-400 hidden">
                                Necesitas 2 grupos para las 16 reacciones
                            </div>
                        </div>
                    </div>

                    <!-- Mode Selector v24 -->
                    <div class="flex p-1 bg-surface-input rounded-xl border border-edge mb-6 max-w-sm mx-auto">
                        <button id="modeReactions" onclick="setCampaignMode('reactions')"
                            class="flex-1 py-2 px-4 rounded-lg text-sm font-semibold transition-all bg-brand text-white shadow-glow">
                            Reacciones
                        </button>
                        <button id="modeViews" onclick="setCampaignMode('views')"
                            class="flex-1 py-2 px-4 rounded-lg text-sm font-semibold transition-all text-txt-secondary hover:text-txt-primary">
                            Visualizaciones
                        </button>
                    </div>

                    <!-- Grid de Reacciones -->
                    <div id="reactionsGrid" class="grid grid-cols-2 sm:grid-cols-3 lg:grid-cols-4 gap-3">
                        <!-- Like -->
                        <div class="reaction-card bg-surface rounded-xl border border-edge p-4 flex flex-col items-center gap-3"
                            data-reaction="like">
                            <div class="text-3xl" role="img" aria-label="Me gusta">&#128077;</div>
                            <span class="text-xs font-medium text-txt-secondary">Me gusta</span>
                            <input type="number" min="0" value="0"
                                class="reaction-input w-full px-3 py-2 rounded-lg bg-surface-input border border-edge text-center text-sm text-txt-primary font-medium focus:outline-none focus:ring-2 focus:ring-brand/50 focus:border-brand transition-all" />
                        </div>
                        <!-- Love -->
                        <div class="reaction-card bg-surface rounded-xl border border-edge p-4 flex flex-col items-center gap-3"
                            data-reaction="love">
                            <div class="text-3xl" role="img" aria-label="Me encanta">&#10084;&#65039;</div>
                            <span class="text-xs font-medium text-txt-secondary">Me encanta</span>
                            <input type="number" min="0" value="0"
                                class="reaction-input w-full px-3 py-2 rounded-lg bg-surface-input border border-edge text-center text-sm text-txt-primary font-medium focus:outline-none focus:ring-2 focus:ring-brand/50 focus:border-brand transition-all" />
                        </div>
                        <!-- Care -->
                        <div class="reaction-card bg-surface rounded-xl border border-edge p-4 flex flex-col items-center gap-3"
                            data-reaction="care">
                            <div class="text-3xl" role="img" aria-label="Me importa">&#129303;</div>
                            <span class="text-xs font-medium text-txt-secondary">Me importa</span>
                            <input type="number" min="0" value="0"
                                class="reaction-input w-full px-3 py-2 rounded-lg bg-surface-input border border-edge text-center text-sm text-txt-primary font-medium focus:outline-none focus:ring-2 focus:ring-brand/50 focus:border-brand transition-all" />
                        </div>
                        <!-- Haha -->
                        <div class="reaction-card bg-surface rounded-xl border border-edge p-4 flex flex-col items-center gap-3"
                            data-reaction="haha">
                            <div class="text-3xl" role="img" aria-label="Me divierte">&#128518;</div>
                            <span class="text-xs font-medium text-txt-secondary">Me divierte</span>
                            <input type="number" min="0" value="0"
                                class="reaction-input w-full px-3 py-2 rounded-lg bg-surface-input border border-edge text-center text-sm text-txt-primary font-medium focus:outline-none focus:ring-2 focus:ring-brand/50 focus:border-brand transition-all" />
                        </div>
                        <!-- Wow -->
                        <div class="reaction-card bg-surface rounded-xl border border-edge p-4 flex flex-col items-center gap-3"
                            data-reaction="wow">
                            <div class="text-3xl" role="img" aria-label="Me asombra">&#128562;</div>
                            <span class="text-xs font-medium text-txt-secondary">Me asombra</span>
                            <input type="number" min="0" value="0"
                                class="reaction-input w-full px-3 py-2 rounded-lg bg-surface-input border border-edge text-center text-sm text-txt-primary font-medium focus:outline-none focus:ring-2 focus:ring-brand/50 focus:border-brand transition-all" />
                        </div>
                        <!-- Sad -->
                        <div class="reaction-card bg-surface rounded-xl border border-edge p-4 flex flex-col items-center gap-3"
                            data-reaction="sad">
                            <div class="text-3xl" role="img" aria-label="Me entristece">&#128546;</div>
                            <span class="text-xs font-medium text-txt-secondary">Me entristece</span>
                            <input type="number" min="0" value="0"
                                class="reaction-input w-full px-3 py-2 rounded-lg bg-surface-input border border-edge text-center text-sm text-txt-primary font-medium focus:outline-none focus:ring-2 focus:ring-brand/50 focus:border-brand transition-all" />
                        </div>
                        <!-- Angry -->
                        <div class="reaction-card bg-surface rounded-xl border border-edge p-4 flex flex-col items-center gap-3"
                            data-reaction="angry">
                            <div class="text-3xl" role="img" aria-label="Me enoja">&#128545;</div>
                            <span class="text-xs font-medium text-txt-secondary">Me enoja</span>
                            <input type="number" min="0" value="0"
                                class="reaction-input w-full px-3 py-2 rounded-lg bg-surface-input border border-edge text-center text-sm text-txt-primary font-medium focus:outline-none focus:ring-2 focus:ring-brand/50 focus:border-brand transition-all" />
                        </div>
                    </div>

                    <!-- Grid de Visualizaciones -->
                    <div id="viewsGrid" class="hidden grid grid-cols-1 sm:grid-cols-2 gap-3 max-w-2xl mx-auto">
                        <!-- Views -->
                        <div class="reaction-card bg-surface rounded-xl border border-edge p-4 flex flex-col items-center gap-3"
                            data-reaction="views">
                            <div class="text-3xl" role="img" aria-label="Solo Views">&#128064;</div>
                            <span class="text-xs font-medium text-txt-secondary">Solo Visualizaciones</span>
                            <input type="number" min="0" value="0"
                                class="reaction-input w-full px-3 py-2 rounded-lg bg-surface-input border border-edge text-center text-sm text-txt-primary font-medium focus:outline-none focus:ring-2 focus:ring-brand/50 focus:border-brand transition-all" />
                        </div>
                        <!-- Timer -->
                        <div class="reaction-card bg-surface rounded-xl border border-edge p-4 flex flex-col items-center gap-3"
                            data-reaction="timer">
                            <div class="text-3xl" role="img" aria-label="Minutos">&#9201;</div>
                            <span class="text-xs font-medium text-txt-secondary">Duracion (Minutos)</span>
                            <input type="number" min="1" value="1" id="minutesInput"
                                class="w-full px-3 py-2 rounded-lg bg-surface-input border border-edge text-center text-sm text-txt-primary font-medium focus:outline-none focus:ring-2 focus:ring-brand/50 focus:border-brand transition-all" />
                        </div>
                    </div>
                </section>

                <!-- Action Button -->
                <div class="flex flex-col sm:flex-row items-center justify-between gap-4 animate-fade-in-delay-3">
                    <p class="text-xs text-txt-muted flex items-center gap-1.5">
                        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                            strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                            <circle cx="12" cy="12" r="10" />
                            <line x1="12" y1="16" x2="12" y2="12" />
                            <line x1="12" y1="8" x2="12.01" y2="8" />
                        </svg>
                        Asegurate de que la URL sea valida antes de iniciar
                    </p>
                    <button id="startBtn" onclick="startCampaign()"
                        class="btn-primary w-full sm:w-auto px-8 py-3.5 rounded-xl text-white font-semibold text-sm flex items-center justify-center gap-2 shadow-glow">
                        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                            strokeWidth="2.5" strokeLinecap="round" strokeLinejoin="round">
                            <polygon points="5 3 19 12 5 21 5 3" />
                        </svg>
                        Iniciar Campana
                    </button>
                </div>

                <!-- Status Log -->
                <section id="statusSection"
                    class="hidden bg-surface-card rounded-2xl border border-edge p-6 shadow-card">
                    <div class="flex items-center gap-2 mb-4">
                        <div class="w-8 h-8 rounded-lg bg-emerald-500/10 flex items-center justify-center">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="rgb(52, 211, 153)"
                                strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                                <polyline points="22 12 18 12 15 21 9 3 6 12 2 12" />
                            </svg>
                        </div>
                        <h2 class="text-base font-semibold text-txt-primary">Estado de la Campana</h2>
                    </div>
                    <div id="statusLog"
                        class="bg-surface rounded-xl border border-edge p-4 max-h-48 overflow-y-auto font-mono text-xs text-txt-secondary flex flex-col gap-1">
                    </div>
                </section>
            </div>
        </main>

        <!-- Footer -->
        <footer class="border-t border-edge px-6 py-4 text-center">
            <p class="text-xs text-txt-muted">Reaction Manager &mdash; Panel de administracion de reacciones</p>
        </footer>
    </div>

    <script>
        // Mapping for backend reaction names
        const REACTION_MAP = {
            'like': 'Me gusta',
            'love': 'Me encanta',
            'care': 'Me importa',
            'haha': 'Me divierte',
            'wow': 'Me asombra',
            'sad': 'Me entristece',
            'angry': 'Me enoja',
            'views': 'Solo Views'
        };

        // Global group storage for filtering
        let allGroupsData = [];
        let campaignMode = 'reactions'; // v24: Default mode

        // Load groups on start
        document.addEventListener('DOMContentLoaded', () => {
            fetch('/api/groups')
                .then(r => r.json())
                .then(groups => {
                    allGroupsData = groups;
                    renderGroups('');
                })
                .catch(err => {
                    console.error('Error fetching groups:', err);
                    document.getElementById('fromGroup').innerHTML = '<option value="">Error cargando grupos</option>';
                });
        });

        // Search filter logic
        document.getElementById('groupFilter').addEventListener('input', (e) => {
            renderGroups(e.target.value.toLowerCase());
        });

        function renderGroups(filter) {
            const startSelect = document.getElementById('fromGroup');
            const endSelect = document.getElementById('toGroup');

            const currentFrom = startSelect.value;
            const currentTo = endSelect.value;

            startSelect.innerHTML = '<option value="">-- Seleccionar --</option>';
            endSelect.innerHTML = '<option value="">-- Solo primer grupo --</option>';

            allGroupsData.forEach(g => {
                const name = g.group_name || `Grupo ${g.group_id}`;
                if (!filter || name.toLowerCase().includes(filter)) {
                    const optStart = document.createElement('option');
                    optStart.value = g.group_id;
                    optStart.innerText = name;
                    if (g.group_id == currentFrom) optStart.selected = true;
                    startSelect.appendChild(optStart);

                    const optEnd = document.createElement('option');
                    optEnd.value = g.group_id;
                    optEnd.innerText = name;
                    if (g.group_id == currentTo) optEnd.selected = true;
                    endSelect.appendChild(optEnd);
                }
            });
        }

        function updateTotal() {
            const inputs = document.querySelectorAll('.reaction-input');
            let total = 0;
            inputs.forEach(function (input) {
                // Solo sumamos si el contenedor no está oculto
                if (!input.closest('.hidden')) {
                    total += parseInt(input.value) || 0;
                }
            });
            document.getElementById('totalCount').textContent = total;
            checkCapacity(total);
        }

        // v25: Verificación de capacidad (Sugerido por el usuario)
        function checkCapacity(needed) {
            const alertEl = document.getElementById('capacityAlert');
            if (needed <= 0) {
                alertEl.classList.add('hidden');
                return;
            }

            // Suponemos un promedio de 10 cuentas por grupo
            const groupsNeeded = Math.ceil(needed / 10);

            if (groupsNeeded > 1) {
                alertEl.textContent = `Necesitas ${groupsNeeded} grupos para las ${needed} reacciones`;
                alertEl.classList.remove('hidden');
            } else {
                alertEl.classList.add('hidden');
            }
        }

        function setCampaignMode(mode) {
            campaignMode = mode;
            const rGrid = document.getElementById('reactionsGrid');
            const vGrid = document.getElementById('viewsGrid');
            const btnR = document.getElementById('modeReactions');
            const btnV = document.getElementById('modeViews');
            const desc = document.getElementById('configDesc');

            if (mode === 'reactions') {
                rGrid.classList.remove('hidden');
                vGrid.classList.add('hidden');
                btnR.className = "flex-1 py-2 px-4 rounded-lg text-sm font-semibold transition-all bg-brand text-white shadow-glow";
                btnV.className = "flex-1 py-2 px-4 rounded-lg text-sm font-semibold transition-all text-txt-secondary hover:text-txt-primary";
                desc.textContent = "Define la cantidad de cada tipo de reaccion";
                vGrid.querySelector('input').value = 0;
            } else {
                vGrid.classList.remove('hidden');
                rGrid.classList.add('hidden');
                btnV.className = "flex-1 py-2 px-4 rounded-lg text-sm font-semibold transition-all bg-brand text-white shadow-glow";
                btnR.className = "flex-1 py-2 px-4 rounded-lg text-sm font-semibold transition-all text-txt-secondary hover:text-txt-primary";
                desc.textContent = "Configura el tiempo de visualizacion";
                rGrid.querySelectorAll('input').forEach(i => i.value = 0);
            }
            updateTotal();
        }

        // Attach event listeners
        document.querySelectorAll('.reaction-input').forEach(function (input) {
            input.addEventListener('input', updateTotal);
            input.addEventListener('change', function () {
                if (this.value === '' || parseInt(this.value) < 0) {
                    this.value = 0;
                }
                updateTotal();
            });
        });

        // Start campaign
        function startCampaign() {
            var url = document.getElementById('postUrl').value.trim();
            var btn = document.getElementById('startBtn');
            var statusSection = document.getElementById('statusSection');
            var statusLog = document.getElementById('statusLog');

            if (!url) {
                shakeElement(document.getElementById('postUrl'));
                document.getElementById('postUrl').focus();
                return;
            }

            var fromGroup = document.getElementById('fromGroup').value;
            if (!fromGroup) {
                shakeElement(document.getElementById('fromGroup'));
                return;
            }

            // Show status section
            statusSection.classList.remove('hidden');
            statusLog.innerHTML = '';

            // Disable button with loading state
            btn.disabled = true;
            const originalHTML = btn.innerHTML;
            btn.innerHTML = '<div class="loading-spinner"></div> Procesando...';
            btn.style.opacity = '0.7';
            btn.style.cursor = 'not-allowed';

            // Gather data
            var toGroup = document.getElementById('toGroup').value;
            var minutes = document.getElementById('minutesInput').value;
            var counts = {};
            document.querySelectorAll('.reaction-card[data-reaction]').forEach(function (card) {
                var type = card.getAttribute('data-reaction');
                if (type !== 'timer') {
                    var input = card.querySelector('input');
                    var backendName = REACTION_MAP[type];
                    if (backendName) {
                        counts[backendName] = parseInt(input.value) || 0;
                    }
                }
            });

            addLog('Iniciando campaña...', 'info');

            fetch('/start_campaign', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    url: url,
                    counts: counts,
                    duration_mins: minutes,
                    group_id: fromGroup,
                    end_group_id: toGroup
                })
            })
                .then(r => r.json())
                .then(data => {
                    if (data.status === 'started') {
                        addLog(data.message, 'success');
                        addLog('Los perfiles se están cargando en segundo plano.', 'info');
                    } else {
                        addLog('Error: ' + data.message, 'error');
                    }

                    // Restore button
                    btn.innerHTML = originalHTML;
                    btn.disabled = false;
                    btn.style.opacity = '1';
                    btn.style.cursor = 'pointer';
                })
                .catch(err => {
                    addLog('Error de conexión con el servidor', 'error');
                    btn.innerHTML = originalHTML;
                    btn.disabled = false;
                    btn.style.opacity = '1';
                    btn.style.cursor = 'pointer';
                });
        }

        function addLog(message, type) {
            var log = document.getElementById('statusLog');
            var entry = document.createElement('div');
            var time = new Date().toLocaleTimeString();
            var colors = {
                'info': 'color: rgb(96, 165, 250)',
                'success': 'color: rgb(52, 211, 153)',
                'error': 'color: rgb(248, 113, 113)',
                'default': 'color: rgb(148, 163, 184)',
            };
            var icons = {
                'info': '&#9432;',
                'success': '&#10003;',
                'error': '&#10007;',
                'default': '&#8250;',
            };
            entry.innerHTML = '<span style="color: rgb(100, 116, 139)">[' + time + ']</span> <span style="' + (colors[type] || colors['default']) + '">' + (icons[type] || icons['default']) + '</span> ' + message;
            entry.style.cssText = colors[type] || colors['default'];
            log.appendChild(entry);
            log.scrollTop = log.scrollHeight;
        }

        function shakeElement(el) {
            el.style.borderColor = 'rgb(248, 113, 113)';
            el.style.animation = 'none';
            el.offsetHeight;
            el.style.animation = 'shake 0.5s ease-in-out';
            setTimeout(function () {
                el.style.borderColor = '';
                el.style.animation = '';
            }, 600);
        }


        // Add shake keyframes
        var style = document.createElement('style');
        style.textContent = '@keyframes shake { 0%, 100% { transform: translateX(0); } 20%, 60% { transform: translateX(-6px); } 40%, 80% { transform: translateX(6px); } }';
        document.head.appendChild(style);
    </script>
</body>

</html>